<% set default_image = 'radixark/miles:dev' %>

<% set fsdp_tests = [
    {'test_file': 'e2e/fsdp/test_qwen3_4B_fsdp_true_on_policy.py', 'num_gpus': 8},
    {'test_file': 'e2e/fsdp/test_qwen3_vl_4B_fsdp.py', 'num_gpus': 8},
    {'test_file': 'e2e/fsdp/test_qwen3_0.6B_fsdp_distributed.py', 'num_gpus': 8},
    {'test_file': 'e2e/fsdp/test_qwen3_0.6B_megatron_fsdp_align.py', 'num_gpus': 8},
] %>

<% set megatron_tests = [
    {'test_file': 'e2e/megatron/test_quick_start_glm4_9B.py', 'num_gpus': 8},
    {'test_file': 'e2e/megatron/test_qwen3_30B_A3B.py', 'num_gpus': 8, 'use_deepep': '1', 'use_fp8_rollout': '1'},
    {'test_file': 'e2e/megatron/test_qwen3_30B_A3B_r3.py', 'num_gpus': 8, 'use_deepep': '1', 'use_fp8_rollout': '1', 'enable_eval': '0'},
    {'test_file': 'e2e/megatron/test_qwen3_30B_A3B_r3.py', 'num_gpus': 8, 'enable_eval': '0'},
    {'test_file': 'e2e/megatron/test_qwen3_4B_ppo.py', 'num_gpus': 8},
    {'test_file': 'e2e/megatron/test_moonlight_16B_A3B.py', 'num_gpus': 8},
    {'test_file': 'e2e/megatron/test_moonlight_16B_A3B_r3.py', 'num_gpus': 8, 'enable_eval': '0'},
    {'test_file': 'e2e/megatron/test_mimo_7B_mtp_only_grad.py', 'num_gpus': 8},
] %>

<% set short_tests = [
    {'test_file': 'e2e/short/test_qwen2.5_0.5B_gsm8k_async_short.py', 'num_gpus': 8},
    {'test_file': 'e2e/short/test_qwen2.5_0.5B_gsm8k_short.py', 'num_gpus': 8},
    {'test_file': 'e2e/short/test_qwen3_0.6B_fsdp_colocated_2xGPU.py', 'num_gpus': 8},
] %>

<% set precision_tests = [
    {'test_file': 'e2e/precision/test_qwen3_0.6B_parallel_check.py', 'num_gpus': 8},
] %>

<% set ckpt_tests = [
    {'test_file': 'e2e/ckpt/test_qwen3_4B_ckpt.py', 'num_gpus': 8},
    {'test_file': 'e2e/ckpt/test_qwen3_4B_ckpt.py --async-save', 'num_gpus': 8},
] %>

<% set long_tests = [
    {'test_file': 'e2e/long/test_qwen2.5_0.5B_gsm8k.py', 'num_gpus': 8},
    {'test_file': 'e2e/long/test_qwen2.5_0.5B_gsm8k_async.py', 'num_gpus': 8},
] %>

<% set jobs = {
    'fast': {
      'test_executor': 'pytest',
      'tests': [
        {'test_file': 'fast', 'num_gpus': 0},
      ],
    },
    'unit-test': {
      'label': 'run-unit-test',
      'tests': [
        {'test_file': 'e2e/fsdp/test_qwen3_4B_fsdp_true_on_policy.py', 'num_gpus': 8}
      ],
    },
    'e2e-test-sglang': {
      'label': 'run-ci-sglang',
      'test_executor': 'pytest',
      'tests': [
        {'test_file': 'e2e/sglang_patch/test_chat_input_ids_equivalence.py', 'num_gpus': 1},
      ],
    },
    'e2e-test-short': {
      'label': 'run-ci-short',
      'tests': short_tests,
    },
    'e2e-test-fsdp': {
      'label': 'run-ci-fsdp',
      'tests': fsdp_tests,
    },
    'e2e-test-megatron': {
      'label': 'run-ci-megatron',
      'tests': megatron_tests,
    },
    'e2e-test-precision': {
      'label': 'run-ci-precision',
      'tests': precision_tests,
    },
    'e2e-test-ckpt': {
      'label': 'run-ci-ckpt',
      'tests': ckpt_tests,
    },
    'e2e-test-long': {
      'label': 'run-ci-long',
      'tests': long_tests,
    },
    'e2e-test-image': {
      'label': 'run-ci-image',
      'tests': fsdp_tests + megatron_tests + short_tests + precision_tests + ckpt_tests + long_tests,
    },
} %>
name: PR Test

on:
  # Do not run CI on push to reduce CI time
  # push:
  #   branches: [main]
  pull_request:
    branches: [main]
    types: [synchronize, labeled]
  workflow_dispatch:
    inputs:
      infinite_run:
        description: 'Run training infinitely'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
<% for job_name, config in jobs.items() %>
  << job_name >>:
    if: (github.event_name == 'workflow_dispatch') || (github.event.pull_request<% if config.label %> && contains(github.event.pull_request.labels.*.name, '<< config.label >>')<% endif %>)
    runs-on: self-hosted
    container:
      image: << config.image if config.image else default_image >>
      options: >
        --gpus all
        --ipc=host
        --shm-size=32g
        --ulimit memlock=-1
        --ulimit stack=67108864
        --memory=0
        --memory-swap=0
        -v /mnt/nvme0n1/miles_ci:/data/miles_ci
        -v /mnt/nvme0n1/miles_ci/models:/root/models
        -v /mnt/nvme0n1/miles_ci/datasets:/root/datasets
        --privileged
        --ulimit nofile=65535:65535
        -v /tmp:/tmp
    strategy:
      fail-fast: false
      matrix:
        info: << config.tests | tojson >>
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    env:
      GITHUB_COMMIT_NAME: ${{ github.sha }}_${{ github.event.pull_request.number || 'non-pr' }}
      WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
      MILES_TEST_ENABLE_INFINITE_RUN: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.infinite_run) || 'false' }}
      MILES_TEST_USE_DEEPEP: ${{ matrix.info.use_deepep || '0' }}
      MILES_TEST_USE_FP8_ROLLOUT: ${{ matrix.info.use_fp8_rollout || '0' }}
      MILES_TEST_ENABLE_EVAL: ${{ matrix.info.enable_eval || '1' }}
      MILES_TEST_FEW_GPU: '0'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cleanup Ray processes
        shell: bash
        run: |
          pkill -9 -f 'ray::' 2>/dev/null || true
          pkill -9 -f raylet 2>/dev/null || true
          pkill -9 -f gcs_server 2>/dev/null || true
          pkill -9 -f 'ray-dashboard' 2>/dev/null || true
          pkill -9 sglang 2>/dev/null || true
          ray stop --force 2>/dev/null || true
          rm -rf /tmp/ray/* 2>/dev/null || true
          sleep 3

      - name: Install
        shell: bash
        run: |
          cd /sgl-workspace/sglang && git fetch origin sglang-miles && git checkout FETCH_HEAD && git log --oneline -1 && pip install -e python --no-deps --break-system-packages
          cd $GITHUB_WORKSPACE && pip install -e . --no-deps --break-system-packages

      - name: Execute
        shell: bash
        run: python tests/ci/gpu_lock_exec.py --count ${{ matrix.info.num_gpus }} -- << config.test_executor | default('python') >> tests/${{ matrix.info.test_file }}
<% endfor %>
