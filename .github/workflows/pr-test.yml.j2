<% set jobs = {
    'e2e-test-short': {
      'label': 'run-ci-short',
      'tests': [
        {'test_file': 'test_qwen2.5_0.5B_gsm8k_async_short.py', 'num_gpus': 4},
        {'test_file': 'test_qwen2.5_0.5B_gsm8k_short.py', 'num_gpus': 4},
        {'test_file': 'test_qwen3_0.6B_fsdp_colocated_2xGPU.py', 'num_gpus': 2},
      ],
    },
    'e2e-test-fsdp': {
      'label': 'run-ci-fsdp',
      'tests': [
        {'test_file': 'test_qwen3_4B_fsdp_true_on_policy.py', 'num_gpus': 2},
        {'test_file': 'test_qwen3_vl_4B_fsdp.py', 'num_gpus': 8},
        {'test_file': 'test_qwen3_0.6B_fsdp_distributed.py', 'num_gpus': 2},
        {'test_file': 'test_qwen3_0.6B_megatron_fsdp_align.py', 'num_gpus': 4},
      ],
    },
    'e2e-test-megatron': {
      'label': 'run-ci-megatron',
      'tests': [
        {'test_file': 'test_quick_start_glm4_9B.py', 'num_gpus': 8},
        {'test_file': 'test_qwen3_30B_A3B.py', 'num_gpus': 8},
        {'test_file': 'test_qwen3_4B_ppo.py', 'num_gpus': 8},
        {'test_file': 'test_moonlight_16B_A3B.py', 'num_gpus': 8},
        {'test_file': 'test_mimo_7B_mtp_only_grad.py', 'num_gpus': 8},
      ],
    },
    'e2e-test-precision': {
      'label': 'run-ci-precision',
      'tests': [
        {'test_file': 'test_qwen3_0.6B_parallel_check.py', 'num_gpus': 8},
        {'test_file': 'test_qwen3_0.6B_megatron_fsdp_align.py', 'num_gpus': 4},
      ],
    },
    'e2e-test-ckpt': {
      'label': 'run-ci-ckpt',
      'tests': [
        {'test_file': 'test_qwen3_4B_ckpt.py', 'num_gpus': 8},
        {'test_file': 'test_qwen3_4B_ckpt.py --async-save', 'num_gpus': 8},
      ],
    },
    'e2e-test-long': {
      'label': 'run-ci-long',
      'tests': [
        {'test_file': 'test_qwen2.5_0.5B_gsm8k.py', 'num_gpus': 2},
        {'test_file': 'test_qwen2.5_0.5B_gsm8k_async.py', 'num_gpus': 2},
      ],
    },
    'e2e-test-image': {
      'label': 'run-ci-image',
      'image': 'radixark/miles-test:latest',
      'tests': [
        {'test_file': 'test_qwen2.5_0.5B_gsm8k_async_short.py', 'num_gpus': 4},
        {'test_file': 'test_qwen2.5_0.5B_gsm8k_short.py', 'num_gpus': 4},
        {'test_file': 'test_qwen3_0.6B_fsdp_colocated_2xGPU.py', 'num_gpus': 2},
        {'test_file': 'test_qwen3_4B_fsdp_true_on_policy.py', 'num_gpus': 2},
        {'test_file': 'test_qwen3_vl_4B_fsdp.py', 'num_gpus': 8},
        {'test_file': 'test_qwen3_0.6B_fsdp_distributed.py', 'num_gpus': 2},
        {'test_file': 'test_quick_start_glm4_9B.py', 'num_gpus': 8},
        {'test_file': 'test_qwen3_30B_A3B.py', 'num_gpus': 8},
        {'test_file': 'test_qwen3_4B_ppo.py', 'num_gpus': 8},
        {'test_file': 'test_moonlight_16B_A3B.py', 'num_gpus': 8},
        {'test_file': 'test_mimo_7B_mtp_only_grad.py', 'num_gpus': 8},
        {'test_file': 'test_qwen3_0.6B_parallel_check.py', 'num_gpus': 8},
        {'test_file': 'test_qwen3_0.6B_megatron_fsdp_align.py', 'num_gpus': 4},
        {'test_file': 'test_qwen3_4B_ckpt.py', 'num_gpus': 8},
        {'test_file': 'test_qwen3_4B_ckpt.py --async-save', 'num_gpus': 8},
        {'test_file': 'test_qwen2.5_0.5B_gsm8k.py', 'num_gpus': 2},
        {'test_file': 'test_qwen2.5_0.5B_gsm8k_async.py', 'num_gpus': 2},
      ],
    },
} %>
name: PR Test

on:
  # Do not run CI on push to reduce CI time
  # push:
  #   branches: [main]
  pull_request:
    branches: [main]
    types: [synchronize, labeled]
  workflow_dispatch:
    inputs:
      infinite_run:
        description: 'Run training infinitely'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
<% for job_name, config in jobs.items() %>
  << job_name >>:
    if: (github.event_name == 'workflow_dispatch') || (github.event.pull_request && contains(github.event.pull_request.labels.*.name, '<< config.label >>'))
    runs-on: self-hosted
    container:
      image: << config.image if config.image else 'radixark/miles:latest' >>
      options: >
        --gpus all
        --ipc=host
        --shm-size=16g
        --ulimit memlock=-1
        --ulimit stack=67108864
        --memory=0
        --memory-swap=0
        -e http_proxy=$http_proxy
        -e https_proxy=$https_proxy
        -e HTTP_PROXY=$HTTP_PROXY
        -e HTTPS_PROXY=$HTTPS_PROXY
        -v /mnt/nvme0n1/miles_ci:/data/miles_ci
        -v /mnt/nvme0n1/miles_ci/models:/root/models
        -v /mnt/nvme0n1/miles_ci/datasets:/root/datasets
    strategy:
      fail-fast: false
      matrix:
        info: << config.tests | tojson >>
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    env:
      GITHUB_COMMIT_NAME: ${{ github.sha }}_${{ github.event.pull_request.number || 'non-pr' }}
      WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
      MILES_TEST_ENABLE_INFINITE_RUN: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.infinite_run) || 'false' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install
        shell: bash
        run: cd $GITHUB_WORKSPACE && pip install -e . --no-deps --break-system-packages

      - name: Execute
        shell: bash
        run: python tests/ci/gpu_lock_exec.py --count ${{ matrix.info.num_gpus }} -- python tests/${{ matrix.info.test_file }}
<% endfor %>